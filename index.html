<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sermon Transcript</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #000;
    color: #fff;
    font-family: 'Inter', system-ui, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #main {
    flex: 1;
    overflow-y: auto;
    padding: 60px 80px 100px;
    scroll-behavior: smooth;
  }
  #main::-webkit-scrollbar { width: 0; }

  #empty {
    display: flex; align-items: center; justify-content: center;
    height: 100%; opacity: 0.12;
    font-size: 15px; font-weight: 300; letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* Each segment block */
  .entry {
    margin-bottom: 60px;
    animation: up 0.4s ease forwards;
    opacity: 0; transform: translateY(8px);
  }
  @keyframes up { to { opacity: 1; transform: translateY(0); } }

  /* Each sentence on its own line */
  .sentence {
    display: block;
    font-size: var(--sentence-size, 46px);
    line-height: 1.5;
    font-weight: 300;
    color: #fff;
    margin-bottom: var(--sentence-spacing, 20px);
  }
  .sentence:last-child { margin-bottom: 0; }

  /* Scripture reference callout */
  .scripture-callout {
    display: block;
    margin-top: 18px;
    padding: 10px 20px;
    border-left: 2px solid #2a2a2a;
    font-size: 16px;
    color: #555;
    letter-spacing: 0.3px;
  }

  /* Music / instrument detected */
  .music-label {
    display: block;
    margin-bottom: 60px;
    font-size: 12px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: #666;
    animation: up 0.4s ease forwards;
    opacity: 0;
  }
  .music-label::before { content: '\266a\0020\0020'; }

  /* Console toggle button - gear icon */
  #console-btn {
    position: fixed; bottom: 20px; right: 22px;
    background: none; border: none;
    color: #666;
    font-size: 22px;
    cursor: pointer; padding: 6px;
    transition: color 0.2s; z-index: 100;
    line-height: 1;
  }
  #console-btn:hover { color: #aaa; }

  /* Console drawer */
  #console-drawer {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #0a0a0a; border-top: 1px solid #1e1e1e;
    transform: translateY(100%);
    transition: transform 0.25s ease;
    z-index: 99; display: flex; flex-direction: column;
    height: 40vh;
    min-height: 160px;
    max-height: 90vh;
  }
  #console-drawer.open { transform: translateY(0); }

  /* Resize handle */
  #resize-handle {
    height: 8px;
    cursor: ns-resize;
    background: transparent;
    border-bottom: 1px solid #1a1a1a;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #resize-handle::after {
    content: '';
    width: 36px; height: 2px;
    background: #333;
    border-radius: 2px;
    margin-top: 1px;
    display: block;
  }
  #resize-handle:hover::after { background: #555; }

  #console-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 20px; border-bottom: 1px solid #1a1a1a; flex-shrink: 0;
  }
  #console-header span { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: #666; }

  #console-controls {
    display: flex; align-items: center; gap: 10px;
    padding: 14px 20px; border-bottom: 1px solid #1a1a1a;
    flex-shrink: 0; flex-wrap: wrap;
  }

  select {
    background: #111; border: 1px solid #2a2a2a; border-radius: 4px;
    padding: 7px 10px; color: #fff; font-family: 'Inter', sans-serif;
    font-size: 12px; outline: none; cursor: pointer;
  }

  .btn {
    padding: 7px 18px; border-radius: 4px; border: 1px solid #2a2a2a;
    font-family: 'Inter', sans-serif; font-size: 12px;
    cursor: pointer; transition: all 0.15s; white-space: nowrap;
    background: transparent;
  }
  .btn-start { background: #fff; color: #000; border-color: #fff; }
  .btn-start:hover { background: #ddd; }
  .btn-stop  { color: #e55; border-color: #e55; }
  .btn-stop:hover { background: rgba(220,50,50,0.08); }
  .btn-muted { color: #555; }
  .btn-muted:hover { color: #aaa; border-color: #666; }

  #log-panel { flex: 1; overflow-y: auto; padding: 10px 20px; }
  #log-panel::-webkit-scrollbar { width: 2px; }
  #log-panel::-webkit-scrollbar-thumb { background: #222; }
  .log { font-family: monospace; font-size: 11px; line-height: 1.8; color: #3a3; }
  .log.err  { color: #e55; }
  .log.warn { color: #b83; }
  .log.info { color: #48f; }

  #toast {
    position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
    background: #1a0000; color: #faa; padding: 10px 18px;
    border-radius: 4px; font-size: 12px; max-width: 400px;
    display: none; z-index: 999; border: 1px solid #500;
    text-align: center; line-height: 1.5;
  }

  /* Typography controls */
  .control-group {
    display: flex; align-items: center; gap: 8px;
    padding: 0 4px;
    border-left: 1px solid #1e1e1e;
  }
  .control-group:first-child { border-left: none; }
  .control-label {
    font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
    color: #555; white-space: nowrap;
  }
  .slider {
    -webkit-appearance: none;
    width: 80px; height: 3px;
    background: #2a2a2a; border-radius: 2px; outline: none;
    cursor: pointer;
  }
  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px; height: 12px;
    border-radius: 50%; background: #888; cursor: pointer;
    transition: background 0.15s;
  }
  .slider::-webkit-slider-thumb:hover { background: #bbb; }
  .slider-val {
    font-size: 10px; color: #555; min-width: 28px; text-align: right;
  }
</style>
</head>
<body>

<div id="main">
  <div id="empty">Waiting for sermon&hellip;</div>
  <div id="transcript"></div>
</div>

<button id="console-btn" onclick="toggleConsole()" title="Admin Console">&#9881;</button>

<div id="console-drawer">
  <div id="resize-handle"></div>
  <div id="console-header">
    <span>Admin Console</span>
    <button class="btn btn-muted" style="padding:4px 10px;font-size:11px" onclick="toggleConsole()">Close</button>
  </div>
  <div id="console-controls">
    <div class="control-group">
      <button class="btn btn-start" id="btn-start" onclick="startSession()">&#9654; Begin</button>
      <button class="btn btn-stop"  id="btn-stop"  onclick="stopSession()" style="display:none">&#9632; Stop</button>
      <button class="btn btn-muted" onclick="clearAll()">Clear</button>
      <button class="btn btn-muted" onclick="downloadTranscript('Manual download')">&#8595; Download</button>
    </div>
    <div class="control-group">
      <span class="control-label">Segment</span>
      <select id="chunk-ms">
        <option value="20000">20s</option>
        <option value="25000" selected>25s</option>
        <option value="30000">30s</option>
      </select>
    </div>
    <div class="control-group">
      <span class="control-label">Size</span>
      <input type="range" class="slider" id="font-size-slider" min="24" max="72" value="46" oninput="applyTypography()">
      <span class="slider-val" id="font-size-val">46px</span>
    </div>
    <div class="control-group">
      <span class="control-label">Spacing</span>
      <input type="range" class="slider" id="line-height-slider" min="12" max="36" value="20" oninput="applyTypography()">
      <span class="slider-val" id="line-height-val">20px</span>
    </div>
  </div>
  <div id="log-panel">
    <div id="log-entries"></div>
  </div>
</div>

<div id="toast"></div>

<script>
// Reliable scroll — waits for paint so new content height is measured correctly
function scrollToBottom() {
  requestAnimationFrame(function() {
    var main = document.getElementById('main');
    main.scrollTop = main.scrollHeight;
  });
}

// ════════════════════════════════════════════════════════════
//  STATE
// ════════════════════════════════════════════════════════════
let mediaRecorder  = null;
let audioChunks    = [];
let isListening    = false;
let micStream      = null;
let chunkTimer     = null;
let queue          = [];
let busy           = false;
let consoleOpen    = false;

const WINDOW_SIZE   = 5;
const SUMMARY_EVERY = 8;
let recentSegments  = [];
let allSegments     = [];
let sermonSummary   = '';
let summarizing     = false;
let lastEnglishTail = '';

// ════════════════════════════════════════════════════════════
//  CONSOLE
// ════════════════════════════════════════════════════════════
function toggleConsole() {
  consoleOpen = !consoleOpen;
  document.getElementById('console-drawer').classList.toggle('open', consoleOpen);
  if (consoleOpen) document.getElementById('log-panel').scrollTop = 99999;
}

function log(msg, cls) {
  cls = cls || '';
  const wrap = document.getElementById('log-entries');
  const el   = document.createElement('div');
  el.className = 'log ' + cls;
  el.textContent = '[' + new Date().toLocaleTimeString('en-US', { hour12: false }) + '] ' + msg;
  wrap.appendChild(el);
  if (consoleOpen) document.getElementById('log-panel').scrollTop = 99999;
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.style.display = 'block';
  clearTimeout(window._tt);
  window._tt = setTimeout(function() { el.style.display = 'none'; }, 7000);
}

// ════════════════════════════════════════════════════════════
//  RECORDING
// ════════════════════════════════════════════════════════════
async function startSession() {
  log('Requesting microphone...', 'info');
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    log('Microphone granted.', 'info');
  } catch (e) {
    log('Mic error: ' + e.message, 'err');
    toast('Microphone error: ' + e.message);
    return;
  }
  isListening = true;
  document.getElementById('btn-start').style.display = 'none';
  document.getElementById('btn-stop').style.display  = 'inline-block';
  document.getElementById('empty').style.display     = 'none';
  recordChunk();
}

function recordChunk() {
  if (!isListening) return;
  audioChunks = [];

  var mime = bestMime();
  var ms   = parseInt(document.getElementById('chunk-ms').value);
  log('Recording ' + (ms / 1000) + 's...');

  try {
    mediaRecorder = mime
      ? new MediaRecorder(micStream, { mimeType: mime })
      : new MediaRecorder(micStream);
  } catch (_) {
    mediaRecorder = new MediaRecorder(micStream);
  }

  mediaRecorder.ondataavailable = function(e) {
    if (e.data && e.data.size > 0) audioChunks.push(e.data);
  };

  mediaRecorder.onstop = function() {
    if (!audioChunks.length) {
      log('Empty chunk, skipping.', 'warn');
      if (isListening) recordChunk();
      return;
    }
    var actualMime = mediaRecorder.mimeType || mime || 'audio/webm';
    var blob = new Blob(audioChunks, { type: actualMime });
    log('Chunk: ' + (blob.size / 1024).toFixed(1) + ' KB', 'info');
    queue.push(blob);
    processNext();
    if (isListening) recordChunk();
  };

  mediaRecorder.start(500);

  chunkTimer = setTimeout(function() {
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  }, ms);
}

function bestMime() {
  var types = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
  for (var i = 0; i < types.length; i++) {
    if (MediaRecorder.isTypeSupported(types[i])) return types[i];
  }
  return '';
}

function stopSession() {
  isListening = false;
  clearTimeout(chunkTimer);
  if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  if (micStream) { micStream.getTracks().forEach(function(t) { t.stop(); }); micStream = null; }
  document.getElementById('btn-start').style.display = 'inline-block';
  document.getElementById('btn-stop').style.display  = 'none';
  log('Stopped.');
  downloadTranscript('Stopped manually');
}

function clearAll() {
  document.getElementById('transcript').innerHTML  = '';
  document.getElementById('log-entries').innerHTML = '';
  document.getElementById('empty').style.display   = '';
  recentSegments  = [];
  allSegments     = [];
  sermonSummary   = '';
  lastEnglishTail = '';
}

// ════════════════════════════════════════════════════════════
//  PIPELINE
// ════════════════════════════════════════════════════════════
async function processNext() {
  if (busy || !queue.length) return;
  busy = true;
  var blob = queue.shift();

  try {
    log('Groq transcribing...');
    var korean = await groqTranscribe(blob);

    if (!korean || korean.trim().length < 3) {
      log('No speech detected.', 'warn');
    } else {
      log('KO: ' + korean.substring(0, 80) + (korean.length > 80 ? '...' : ''), 'info');
      log('Claude translating...');
      var result = await claudeTranslate(korean);

      if (result.music) {
        log('Music detected: ' + result.music, 'info');
        renderMusic(result.music);
      } else {
        log('EN: ' + result.english.substring(0, 80) + (result.english.length > 80 ? '...' : ''), 'info');

        var seg = { korean: korean, english: result.english };
        recentSegments.push(seg);
        if (recentSegments.length > WINDOW_SIZE) recentSegments.shift();
        allSegments.push(seg);

        var sentences = result.english.match(/[^.!?]+[.!?]+/g) || [result.english];
        lastEnglishTail = sentences.slice(-2).join(' ').trim();

        renderEntry(result);

        if (allSegments.length % SUMMARY_EVERY === 0 && !summarizing) {
          generateSermonSummary();
        }
      }
    }
  } catch (e) {
    log('Error: ' + e.message, 'err');
    toast(e.message);
  }

  busy = false;
  processNext();
}

// ════════════════════════════════════════════════════════════
//  GROQ
// ════════════════════════════════════════════════════════════
async function groqTranscribe(blob) {
  var mimeMap = {
    'audio/webm': 'webm', 'audio/ogg': 'ogg',
    'audio/mp4': 'mp4', 'audio/mpeg': 'mp3', 'audio/wav': 'wav'
  };
  var baseMime = (blob.type || 'audio/webm').split(';')[0];
  var ext      = mimeMap[baseMime] || 'webm';

  var audioBase64 = await new Promise(function(res, rej) {
    var reader = new FileReader();
    reader.onload  = function() { res(reader.result.split(',')[1]); };
    reader.onerror = function() { rej(new Error('Failed to read audio')); };
    reader.readAsDataURL(blob);
  });

  var resp = await fetch('/api/groq', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ audioBase64: audioBase64, mimeType: baseMime, ext: ext })
  });

  if (!resp.ok) {
    var msg = 'Groq HTTP ' + resp.status;
    try { var j = await resp.json(); msg = j.error || msg; } catch (_) {}
    throw new Error('Groq: ' + msg);
  }
  return (await resp.text()).trim();
}

// ════════════════════════════════════════════════════════════
//  CLAUDE
// ════════════════════════════════════════════════════════════
function buildPrompt(korean) {
  var p = '';
  if (sermonSummary) p += 'SERMON SUMMARY:\n' + sermonSummary + '\n\n';
  if (recentSegments.length) {
    p += 'RECENT TRANSCRIPT:\n';
    recentSegments.forEach(function(s, i) { p += '[' + (i+1) + '] ' + s.english + '\n'; });
    p += '\n';
  }
  if (lastEnglishTail) {
    p += 'PREVIOUS SEGMENT ENDED WITH:\n"' + lastEnglishTail + '"\n(New segment may continue mid-sentence.)\n\n';
  }
  p += 'NEW SEGMENT:\n' + korean;
  return p;
}

async function claudeTranslate(korean) {
  var system = 'You are a Korean-to-English translation assistant for a live Christian church service displayed on screen.\n\n' +
    'The microphone may pick up not just the pastor speaking, but also musical instruments (piano, guitar, organ, drums, etc.), congregational singing, or ambient sounds.\n\n' +
    'RULES:\n' +
    '1. If the audio contains ONLY music, instruments, or singing with no clear spoken sermon content, respond with: {"music":"Piano playing"} or {"music":"Congregation singing"} or {"music":"Worship music"} etc. Be concise and descriptive.\n' +
    '2. If the audio contains spoken Korean sermon content (even alongside music), translate it normally.\n' +
    '3. Translate naturally and fluently. No wooden or literal phrasing.\n' +
    '4. Use context to maintain consistent terminology and complete sentences cut off mid-thought.\n' +
    '5. Remove all filler words (um, uh, and Korean equivalents: \uc74c, \uc5b4, \uadf8, \uc774\uc81c, \uadf8\ub83c\uc11c, etc.) and stutters.\n' +
    '6. Preserve theological terms: \ud558\ub098\ub2d8\u2192God | \uc608\uc218\ub2d8\u2192Jesus Christ | \uc131\ub839\u2192the Holy Spirit | \uc8fc\ub2d8\u2192the Lord | \ub9d0\uc3f4\u2192the Word | \uc740\ud61c\u2192grace | \uad6c\uc6d0\u2192salvation | \uc2ed\uc790\uac00\u2192the cross | \ubd80\ud65c\u2192the resurrection | \ubbf8\ub364\u2192faith | \uae30\ub3c4\u2192prayer\n' +
    '7. Convert Korean Bible references: \uc694\ud55c\ubcf5\uc74c 3\uc7a5 16\uc808\u2192John 3:16 | \uc2dc\ud3b8 23\ud3b8\u2192Psalm 23\n\n' +
    'Respond ONLY in valid JSON, no markdown:\n' +
    'For speech: {"english":"translated text","scripture":[{"ref":"John 3:16","note":""}]}\n' +
    'For music only: {"music":"description of what is playing"}';

  var lastErr;
  for (var attempt = 1; attempt <= 3; attempt++) {
    try {
      var resp = await fetch('/api/claude', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 700,
          system: system,
          messages: [{ role: 'user', content: buildPrompt(korean) }]
        })
      });

      if (!resp.ok) {
        var msg = 'Claude HTTP ' + resp.status;
        try { var j = await resp.json(); msg = j.error?.message || msg; } catch (_) {}
        throw new Error('Claude: ' + msg);
      }

      var data = await resp.json();
      var raw  = data.content.map(function(b) { return b.text || ''; }).join('').trim();
      try {
        return JSON.parse(raw.replace(/^```json|^```|```$/gm, '').trim());
      } catch (_) {
        return { english: raw, scripture: [] };
      }
    } catch (e) {
      lastErr = e;
      if (attempt < 3) {
        log('Retry ' + attempt + '...', 'warn');
        await new Promise(function(r) { setTimeout(r, 1500 * attempt); });
      }
    }
  }
  throw lastErr;
}

// ════════════════════════════════════════════════════════════
//  BACKGROUND SUMMARY
// ════════════════════════════════════════════════════════════
async function generateSermonSummary() {
  summarizing = true;
  log('Updating sermon summary...', 'info');
  var transcript = allSegments.map(function(s, i) { return '[' + (i+1) + '] ' + s.english; }).join('\n');
  try {
    var resp = await fetch('/api/claude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 200,
        messages: [{
          role: 'user',
          content: 'Summarize this Christian sermon in 3 sentences for a translation assistant. Cover: main theme, key points, central scriptures, direction. Plain prose only.\n\n' + transcript
        }]
      })
    });
    if (resp.ok) {
      var data = await resp.json();
      sermonSummary = data.content.map(function(b) { return b.text || ''; }).join('').trim();
      log('Summary updated.', 'info');
    }
  } catch (e) {
    log('Summary failed: ' + e.message, 'warn');
  }
  summarizing = false;
}


// ════════════════════════════════════════════════════════════
//  DOWNLOAD TRANSCRIPT
// ════════════════════════════════════════════════════════════
function downloadTranscript(reason) {
  if (!allSegments.length) return;

  var date = new Date().toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
  var time = new Date().toLocaleTimeString('en-US', {
    hour: '2-digit', minute: '2-digit'
  });

  var lines = [];
  lines.push('SERMON TRANSCRIPT');
  lines.push(date + ' at ' + time);
  if (reason) lines.push('(' + reason + ')');
  lines.push('');
  lines.push('─'.repeat(60));
  lines.push('');

  allSegments.forEach(function(s, i) {
    lines.push(s.english);
    lines.push('');
  });

  lines.push('─'.repeat(60));
  lines.push(allSegments.length + ' segments transcribed.');

  var blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  var filename = 'sermon-' + new Date().toISOString().slice(0,10) + '.txt';
  a.href     = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  log('Transcript downloaded: ' + filename, 'info');
}

// ════════════════════════════════════════════════════════════
//  RENDER
// ════════════════════════════════════════════════════════════
function renderMusic(description) {
  var wrap  = document.getElementById('transcript');
  var label = document.createElement('div');
  label.className   = 'music-label';
  label.textContent = description;
  wrap.appendChild(label);
  scrollToBottom();
}

function renderEntry(result) {
  var wrap  = document.getElementById('transcript');
  var entry = document.createElement('div');
  entry.className = 'entry';

  // Split english into individual sentences for easier reading
  var englishText = result.english || '';
  var rawSentences = englishText.match(/[^.!?]+[.!?]*/g) || [englishText];
  // Filter out empty strings
  var sentences = rawSentences.filter(function(s) { return s.trim().length > 0; });

  var sentencesHTML = sentences.map(function(s) {
    var escaped = esc(s.trim());
    // Highlight any scripture refs inline
    if (result.scripture && result.scripture.length) {
      result.scripture.forEach(function(sc) {
        if (!sc.ref) return;
        var safe = sc.ref.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        escaped = escaped.replace(new RegExp(safe, 'g'),
          '<span style="color:#666;border-bottom:1px solid #2a2a2a">' + sc.ref + '</span>');
      });
    }
    return '<span class="sentence">' + escaped + '</span>';
  }).join('');

  var scriptureBlocks = (result.scripture || [])
    .filter(function(s) { return s.ref; })
    .map(function(s) {
      return '<span class="scripture-callout">&#128214; ' + esc(s.ref) + (s.note ? ' \u2014 ' + esc(s.note) : '') + '</span>';
    }).join('');

  entry.innerHTML = sentencesHTML + scriptureBlocks;

  wrap.appendChild(entry);
  scrollToBottom();
}

function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}


// ════════════════════════════════════════════════════════════
//  TYPOGRAPHY CONTROLS
// ════════════════════════════════════════════════════════════
function applyTypography() {
  var fontSize   = parseInt(document.getElementById('font-size-slider').value);
  var lineHeight = parseInt(document.getElementById('line-height-slider').value);

  document.getElementById('font-size-val').textContent   = fontSize + 'px';
  document.getElementById('line-height-val').textContent = lineHeight + 'px';

  // Apply to all existing and future sentences via CSS vars
  document.documentElement.style.setProperty('--sentence-size',    fontSize + 'px');
  document.documentElement.style.setProperty('--sentence-spacing',  lineHeight + 'px');

  // Scroll to bottom after resize so latest text stays visible
  var main = document.getElementById('main');
  main.scrollTop = main.scrollHeight;
}

// Init CSS vars on load
document.addEventListener('DOMContentLoaded', function() { applyTypography(); });


// Download transcript if page is closed or refreshed
window.addEventListener('beforeunload', function() {
  downloadTranscript('Page closed');
});

// ════════════════════════════════════════════════════════════
//  RESIZE CONSOLE DRAWER
// ════════════════════════════════════════════════════════════
(function() {
  var handle  = document.getElementById('resize-handle');
  var drawer  = document.getElementById('console-drawer');
  var startY  = 0;
  var startH  = 0;
  var dragging = false;

  handle.addEventListener('mousedown', function(e) {
    dragging = true;
    startY   = e.clientY;
    startH   = drawer.offsetHeight;
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  document.addEventListener('mousemove', function(e) {
    if (!dragging) return;
    var delta  = startY - e.clientY;  // drag up = bigger
    var newH   = Math.min(Math.max(startH + delta, 160), window.innerHeight * 0.9);
    drawer.style.height = newH + 'px';
  });

  document.addEventListener('mouseup', function() {
    dragging = false;
    document.body.style.userSelect = '';
  });

  // Touch support
  handle.addEventListener('touchstart', function(e) {
    dragging = true;
    startY   = e.touches[0].clientY;
    startH   = drawer.offsetHeight;
    e.preventDefault();
  }, { passive: false });

  document.addEventListener('touchmove', function(e) {
    if (!dragging) return;
    var delta = startY - e.touches[0].clientY;
    var newH  = Math.min(Math.max(startH + delta, 160), window.innerHeight * 0.9);
    drawer.style.height = newH + 'px';
  }, { passive: true });

  document.addEventListener('touchend', function() { dragging = false; });
})();
</script>
</body>
</html>
