<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sermon Transcript</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #000;
    color: #fff;
    font-family: 'Inter', system-ui, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #main {
    flex: 1;
    overflow-y: auto;
    padding: 60px 80px 100px;
    scroll-behavior: smooth;
  }
  #main::-webkit-scrollbar { width: 0; }

  #empty {
    display: flex; align-items: center; justify-content: center;
    height: 100%; opacity: 0.12;
    font-size: 15px; font-weight: 300; letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* Each segment block */
  .entry {
    margin-bottom: 60px;
    animation: up 0.4s ease forwards;
    opacity: 0; transform: translateY(8px);
  }
  @keyframes up { to { opacity: 1; transform: translateY(0); } }

  /* Each sentence on its own line */
  .sentence {
    display: block;
    font-size: var(--sentence-size, 46px);
    line-height: 1.5;
    font-weight: 300;
    color: #fff;
    margin-bottom: var(--sentence-spacing, 20px);
  }
  .sentence:last-child { margin-bottom: 0; }
  .sentence[contenteditable="true"]:hover { outline: 1px solid #2a2a2a; outline-offset: 2px; border-radius: 2px; }
  .sentence[contenteditable="true"]:focus { outline: 1px solid #444; outline-offset: 3px; border-radius: 2px; }

  /* Scripture reference callout */
  .scripture-callout {
    display: block;
    margin-top: 18px;
    padding: 10px 20px;
    border-left: 2px solid #2a2a2a;
    font-size: 16px;
    color: #555;
    letter-spacing: 0.3px;
  }

  /* Music / instrument detected */
  .music-label {
    display: block;
    margin-bottom: 60px;
    font-size: 12px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: #666;
    animation: up 0.4s ease forwards;
    opacity: 0;
  }
  .music-label::before { content: '\266a\0020\0020'; }

  /* Console toggle button - gear icon */
  #console-btn {
    position: fixed; bottom: 20px; right: 22px;
    background: none; border: none;
    color: #666;
    font-size: 22px;
    cursor: pointer; padding: 6px;
    transition: color 0.2s; z-index: 100;
    line-height: 1;
  }
  #console-btn:hover { color: #aaa; }

  /* Console drawer */
  #console-drawer {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #0a0a0a; border-top: 1px solid #1e1e1e;
    transform: translateY(100%);
    transition: transform 0.25s ease;
    z-index: 99; display: flex; flex-direction: column;
    height: 40vh;
    min-height: 160px;
    max-height: 90vh;
  }
  #console-drawer.open { transform: translateY(0); }

  /* Resize handle */
  #resize-handle {
    height: 8px;
    cursor: ns-resize;
    background: transparent;
    border-bottom: 1px solid #1a1a1a;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #resize-handle::after {
    content: '';
    width: 36px; height: 2px;
    background: #333;
    border-radius: 2px;
    margin-top: 1px;
    display: block;
  }
  #resize-handle:hover::after { background: #555; }

  #console-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 20px; border-bottom: 1px solid #1a1a1a; flex-shrink: 0;
  }
  #console-header span { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: #666; }

  #console-controls {
    display: flex; align-items: center; gap: 10px;
    padding: 14px 20px; border-bottom: 1px solid #1a1a1a;
    flex-shrink: 0; flex-wrap: wrap;
  }

  select {
    background: #111; border: 1px solid #2a2a2a; border-radius: 4px;
    padding: 7px 10px; color: #fff; font-family: 'Inter', sans-serif;
    font-size: 12px; outline: none; cursor: pointer;
  }

  .btn {
    padding: 7px 18px; border-radius: 4px; border: 1px solid #2a2a2a;
    font-family: 'Inter', sans-serif; font-size: 12px;
    cursor: pointer; transition: all 0.15s; white-space: nowrap;
    background: transparent;
  }
  .btn-start { background: #fff; color: #000; border-color: #fff; }
  .btn-start:hover { background: #ddd; }
  .btn-stop  { color: #e55; border-color: #e55; }
  .btn-stop:hover { background: rgba(220,50,50,0.08); }
  .btn-muted { color: #555; }
  .btn-muted:hover { color: #aaa; border-color: #666; }

  #log-panel { flex: 1; overflow-y: auto; padding: 10px 20px; }
  #log-panel::-webkit-scrollbar { width: 2px; }
  #log-panel::-webkit-scrollbar-thumb { background: #222; }
  .log { font-family: monospace; font-size: 11px; line-height: 1.8; color: #3a3; }
  .log.err  { color: #e55; }
  .log.warn { color: #b83; }
  .log.info { color: #48f; }

  /* Remote control bar (phone view) */
  #remote-bar {
    position: fixed; top: 0; left: 0; right: 0;
    background: #0a0a0a; border-bottom: 1px solid #1e1e1e;
    display: flex; align-items: center; gap: 10px;
    padding: 10px 20px; z-index: 200; flex-wrap: wrap;
  }
  .remote-status { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; margin-right: auto; }
  .remote-status.live    { color: #3a3; }
  .remote-status.ready   { color: #555; }
  .remote-status.offline { color: #e55; }

  #toast {
    position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
    background: #1a0000; color: #faa; padding: 10px 18px;
    border-radius: 4px; font-size: 12px; max-width: 400px;
    display: none; z-index: 999; border: 1px solid #500;
    text-align: center; line-height: 1.5;
  }

  /* Typography controls */
  .control-group {
    display: flex; align-items: center; gap: 8px;
    padding: 0 4px;
    border-left: 1px solid #1e1e1e;
  }
  .control-group:first-child { border-left: none; }
  .control-label {
    font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
    color: #555; white-space: nowrap;
  }
  .slider {
    -webkit-appearance: none;
    width: 80px; height: 3px;
    background: #2a2a2a; border-radius: 2px; outline: none;
    cursor: pointer;
  }
  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px; height: 12px;
    border-radius: 50%; background: #888; cursor: pointer;
    transition: background 0.15s;
  }
  .slider::-webkit-slider-thumb:hover { background: #bbb; }
  .slider-val {
    font-size: 10px; color: #555; min-width: 28px; text-align: right;
  }
</style>
</head>
<body>

<div id="main">
  <div id="empty">Waiting for sermon&hellip;</div>
  <div id="transcript"></div>
</div>

<button id="console-btn" onclick="toggleConsole()" title="Admin Console">&#9881;</button>

<div id="console-drawer">
  <div id="resize-handle"></div>
  <div id="console-header">
    <span>Admin Console</span>
    <span id="queue-depth" style="font-size:10px;letter-spacing:1px;text-transform:uppercase;margin-left:auto;margin-right:16px;"></span>
    <button class="btn btn-muted" style="padding:4px 10px;font-size:11px" onclick="popOutConsole()" title="Pop out console">&#8599;</button>
    <button class="btn btn-muted" style="padding:4px 10px;font-size:11px" onclick="toggleConsole()">Close</button>
  </div>
  <div id="console-controls">
    <div class="control-group">
      <button class="btn btn-start" id="btn-start" onclick="startSession()">&#9654; Begin</button>
      <button class="btn btn-stop"  id="btn-stop"  onclick="stopSession()" style="display:none">&#9632; Stop</button>
      <button class="btn btn-muted" onclick="clearAll()">Clear</button>
      <button class="btn btn-muted" onclick="downloadTranscript('Manual download')">&#8595; Download</button>
    </div>
    <div class="control-group">
      <span class="control-label">Segment</span>
      <select id="chunk-ms">
        <option value="20000">20s</option>
        <option value="25000">25s</option>
        <option value="30000" selected>30s</option>
      </select>
    </div>
    <div class="control-group">
      <span class="control-label">Size</span>
      <input type="range" class="slider" id="font-size-slider" min="24" max="72" value="46" oninput="applyTypography()">
      <span class="slider-val" id="font-size-val">46px</span>
    </div>
    <div class="control-group">
      <span class="control-label">Spacing</span>
      <input type="range" class="slider" id="line-height-slider" min="12" max="36" value="20" oninput="applyTypography()">
      <span class="slider-val" id="line-height-val">20px</span>
    </div>
  </div>
  <div id="log-panel">
    <div id="log-entries"></div>
  </div>
</div>

<div id="toast"></div>

<script>
// Reliable scroll — waits for paint so new content height is measured correctly
function scrollToBottom() {
  if (document.activeElement && document.activeElement.isContentEditable) return;
  requestAnimationFrame(function() {
    var main = document.getElementById('main');
    main.scrollTop = main.scrollHeight;
  });
}

// ════════════════════════════════════════════════════════════
//  STATE
// ════════════════════════════════════════════════════════════
var isRemote = location.search.indexOf('remote') !== -1;

let mediaRecorder  = null;
let audioChunks    = [];
let isListening    = false;
let micStream      = null;
let chunkTimer     = null;
let queue          = [];
let busy           = false;
let consoleOpen    = false;
let logHistory     = [];   // last 100 entries, replayed into popup on open
let consoleWindow  = null; // reference to detached popup

const WINDOW_SIZE   = 8;
const SUMMARY_EVERY = 8;
let recentSegments  = [];
let allSegments     = [];
let sermonSummary   = '';
let summarizing     = false;
let lastEnglishTail = '';

// ════════════════════════════════════════════════════════════
//  CONSOLE
// ════════════════════════════════════════════════════════════
function toggleConsole() {
  if (consoleWindow && !consoleWindow.closed) {
    consoleWindow.focus();
    return;
  }
  consoleOpen = !consoleOpen;
  document.getElementById('console-drawer').classList.toggle('open', consoleOpen);
  if (consoleOpen) document.getElementById('log-panel').scrollTop = 99999;
}

function log(msg, cls) {
  cls = cls || '';
  var text = '[' + new Date().toLocaleTimeString('en-US', { hour12: false }) + '] ' + msg;

  logHistory.push({ text: text, cls: cls });
  if (logHistory.length > 100) logHistory.shift();

  if (consoleWindow && !consoleWindow.closed) {
    consoleWindow.addLog(text, cls);
  }

  const wrap = document.getElementById('log-entries');
  const el   = document.createElement('div');
  el.className = 'log ' + cls;
  el.textContent = text;
  wrap.appendChild(el);
  while (wrap.children.length > 150) wrap.removeChild(wrap.firstChild);
  if (consoleOpen) document.getElementById('log-panel').scrollTop = 99999;
}

function updateQueueDepth() {
  var el = document.getElementById('queue-depth');
  if (!el) return;
  var n = queue.length;
  el.textContent = n ? 'Queue: ' + n + ' pending' : '';
  el.style.color = n > 2 ? '#e55' : '#b83';
  if (consoleWindow && !consoleWindow.closed) {
    consoleWindow.setQueue(n);
  }
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.style.display = 'block';
  clearTimeout(window._tt);
  window._tt = setTimeout(function() { el.style.display = 'none'; }, 7000);
}

// ════════════════════════════════════════════════════════════
//  SYNC  (laptop → Netlify Blobs ← phone)
// ════════════════════════════════════════════════════════════

// ── Laptop side ──────────────────────────────────────────────
function pushSync(type, data) {
  if (isRemote) return;
  fetch('/api/sync-push', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type: type, data: data })
  }).catch(function() {});  // fire-and-forget; never block main flow
}

var lastCommandId = 0;
async function pollCommands() {
  if (isRemote) return;
  try {
    // Check for commands from phone
    var cmdResp = await fetch('/api/sync-command');
    if (cmdResp.ok) {
      var cmd = await cmdResp.json();
      if (cmd.command && cmd.id && cmd.id !== lastCommandId) {
        lastCommandId = cmd.id;
        if      (cmd.command === 'start'      && !isListening) startSession();
        else if (cmd.command === 'stop'       &&  isListening) stopSession();
        else if (cmd.command === 'clear')                      clearAll();
        else if (cmd.command === 'setChunkMs' && cmd.value) {
          var sel = document.getElementById('chunk-ms');
          if (sel) sel.value = cmd.value;
        }
      }
    }
    // Apply edits from phone to laptop DOM
    var editResp = await fetch('/api/sync-pull?since=9999999999999&sinceEdit=' + lastEditId);
    if (editResp.ok) {
      var data = await editResp.json();
      (data.edits || []).forEach(function(edit) {
        if (edit.id > lastEditId) lastEditId = edit.id;
        applyEdit(edit);
      });
    }
  } catch (_) {}
}

// ── Remote (phone) side ──────────────────────────────────────
var lastEntryId  = 0;
var lastEditId   = 0;
var lastClearedAt = 0;

async function pollRemote() {
  try {
    var resp = await fetch('/api/sync-pull?since=' + lastEntryId + '&sinceEdit=' + lastEditId);
    if (!resp.ok) { setRemoteStatus('offline'); return; }
    var data = await resp.json();

    if (data.state) updateRemoteState(data.state);

    (data.entries || []).forEach(function(entry) {
      if (entry.id > lastEntryId) lastEntryId = entry.id;
      renderRemoteEntry(entry);
    });

    (data.edits || []).forEach(function(edit) {
      if (edit.id > lastEditId) lastEditId = edit.id;
      applyEdit(edit);
    });

    setRemoteStatus((data.state && data.state.isListening) ? 'live' : 'ready');
  } catch (_) {
    setRemoteStatus('offline');
  }
}

function setRemoteStatus(status) {
  var el = document.getElementById('remote-status');
  if (!el) return;
  el.className = 'remote-status ' + status;
  el.textContent = status === 'live' ? '\u25cf Live' : status === 'offline' ? '\u25cb Offline' : '\u25cb Ready';
}

function updateRemoteState(state) {
  var btnStart = document.getElementById('remote-start');
  var btnStop  = document.getElementById('remote-stop');
  if (!btnStart || !btnStop) return;
  btnStart.style.display = state.isListening ? 'none'         : 'inline-block';
  btnStop.style.display  = state.isListening ? 'inline-block' : 'none';
  document.getElementById('empty').style.display = state.isListening ? 'none' : '';

  // Laptop called clearAll — wipe phone DOM too
  if (state.clearedAt && state.clearedAt > lastClearedAt) {
    lastClearedAt = state.clearedAt;
    lastEntryId   = 0;
    lastEditId    = 0;
    document.getElementById('transcript').innerHTML = '';
    document.getElementById('empty').style.display  = '';
  }
}

async function sendCommand(command, value) {
  try {
    var payload = { command: command, id: Date.now() };
    if (value !== undefined) payload.value = value;
    await fetch('/api/sync-command', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (_) {}
}

// Push an edit from either device — no isRemote guard
function pushEdit(entryId, sentences) {
  fetch('/api/sync-push', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type: 'editEntry', data: { id: Date.now(), entryId: entryId, sentences: sentences } })
  }).catch(function() {});
}

// Attach blur listeners to an entry's sentences so edits sync to the other device
function addEditListeners(entryEl, entryId) {
  entryEl.querySelectorAll('.sentence').forEach(function(span) {
    span.addEventListener('blur', function() {
      var texts = Array.from(entryEl.querySelectorAll('.sentence')).map(function(s) { return s.textContent.trim(); });
      pushEdit(entryId, texts);
    });
  });
}

// Apply an incoming edit to the matching entry in the local DOM
function applyEdit(edit) {
  var entryEl = document.querySelector('[data-entry-id="' + edit.entryId + '"]');
  if (!entryEl) return;
  var spans = entryEl.querySelectorAll('.sentence');
  (edit.sentences || []).forEach(function(text, i) {
    if (spans[i] && document.activeElement !== spans[i]) {
      spans[i].textContent = text;
    }
  });
}

// Phone-local typography (doesn't affect laptop display)
function applyRemoteTypo(type, val) {
  if (type === 'size')    document.documentElement.style.setProperty('--sentence-size',    val + 'px');
  else                    document.documentElement.style.setProperty('--sentence-spacing', val + 'px');
}

function renderRemoteEntry(entry) {
  document.getElementById('empty').style.display = 'none';
  var wrap = document.getElementById('transcript');

  if (entry.type === 'music') {
    var label = document.createElement('div');
    label.className   = 'music-label';
    label.textContent = entry.description;
    wrap.appendChild(label);
  } else {
    var div = document.createElement('div');
    div.className = 'entry';
    div.dataset.entryId = String(entry.id);
    var html = (entry.sentences || []).map(function(s) {
      return '<span class="sentence" contenteditable="true">' + esc(s) + '</span>';
    }).join('');
    if (entry.scripture && entry.scripture.length) {
      html += entry.scripture.filter(function(sc) { return sc.ref; }).map(function(sc) {
        return '<span class="scripture-callout">&#128214; ' + esc(sc.ref) + (sc.note ? ' \u2014 ' + esc(sc.note) : '') + '</span>';
      }).join('');
    }
    div.innerHTML = html;
    wrap.appendChild(div);
    addEditListeners(div, entry.id);
  }
  scrollToBottom();
}

function initRemote() {
  // Hide laptop-only chrome
  document.getElementById('console-btn').style.display    = 'none';
  document.getElementById('console-drawer').style.display = 'none';

  // Shift content below the remote bar
  document.getElementById('main').style.paddingTop = '56px';

  // Set typography defaults (sliders don't exist in remote view)
  document.documentElement.style.setProperty('--sentence-size',    '46px');
  document.documentElement.style.setProperty('--sentence-spacing', '20px');

  // Inject remote control bar
  var bar = document.createElement('div');
  bar.id = 'remote-bar';
  bar.innerHTML =
    '<span id="remote-status" class="remote-status offline">\u25cb Connecting\u2026</span>' +
    '<button class="btn btn-start" id="remote-start" onclick="sendCommand(\'start\')">&#9654; Begin</button>' +
    '<button class="btn btn-stop"  id="remote-stop"  onclick="sendCommand(\'stop\')"  style="display:none">&#9632; Stop</button>' +
    '<button class="btn btn-muted" onclick="sendCommand(\'clear\')">Clear</button>' +
    '<button class="btn btn-muted" onclick="downloadTranscript(\'Remote download\')">&#8595; Download</button>';
  document.body.insertBefore(bar, document.body.firstChild);

  // Start polling
  pollRemote();
  setInterval(pollRemote, 1500);
}

// ════════════════════════════════════════════════════════════
//  RECORDING
// ════════════════════════════════════════════════════════════
async function startSession() {
  log('Requesting microphone...', 'info');
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    log('Microphone granted.', 'info');
  } catch (e) {
    log('Mic error: ' + e.message, 'err');
    toast('Microphone error: ' + e.message);
    return;
  }
  isListening = true;
  document.getElementById('btn-start').style.display = 'none';
  document.getElementById('btn-stop').style.display  = 'inline-block';
  document.getElementById('empty').style.display     = 'none';
  syncPopupState();
  pushSync('state', { isListening: true, chunkMs: parseInt(document.getElementById('chunk-ms').value) });
  log('Remote: ' + location.origin + location.pathname + '?remote', 'info');
  recordChunk();
}

function recordChunk() {
  if (!isListening) return;
  audioChunks = [];

  var mime = bestMime();
  var ms   = parseInt(document.getElementById('chunk-ms').value);
  log('Recording ' + (ms / 1000) + 's...');

  try {
    mediaRecorder = mime
      ? new MediaRecorder(micStream, { mimeType: mime })
      : new MediaRecorder(micStream);
  } catch (_) {
    mediaRecorder = new MediaRecorder(micStream);
  }

  mediaRecorder.ondataavailable = function(e) {
    if (e.data && e.data.size > 0) audioChunks.push(e.data);
  };

  mediaRecorder.onstop = function() {
    if (!audioChunks.length) {
      log('Empty chunk, skipping.', 'warn');
      if (isListening) recordChunk();
      return;
    }
    var actualMime = mediaRecorder.mimeType || mime || 'audio/webm';
    var blob = new Blob(audioChunks, { type: actualMime });
    log('Chunk: ' + (blob.size / 1024).toFixed(1) + ' KB', 'info');
    if (blob.size < 8000) {
      log('Chunk too small (silence), skipping.', 'warn');
      if (isListening) recordChunk();
      return;
    }
    queue.push(blob);
    processNext();
    if (isListening) recordChunk();
  };

  mediaRecorder.start(500);

  chunkTimer = setTimeout(function() {
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  }, ms);
}

function bestMime() {
  var types = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
  for (var i = 0; i < types.length; i++) {
    if (MediaRecorder.isTypeSupported(types[i])) return types[i];
  }
  return '';
}

function stopSession() {
  isListening = false;
  clearTimeout(chunkTimer);
  if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  if (micStream) { micStream.getTracks().forEach(function(t) { t.stop(); }); micStream = null; }
  document.getElementById('btn-start').style.display = 'inline-block';
  document.getElementById('btn-stop').style.display  = 'none';
  log('Stopped.');
  syncPopupState();
  pushSync('state', { isListening: false, chunkMs: parseInt(document.getElementById('chunk-ms').value) });
  downloadTranscript('Stopped manually');
}

function clearAll() {
  document.getElementById('transcript').innerHTML  = '';
  document.getElementById('log-entries').innerHTML = '';
  document.getElementById('empty').style.display   = '';
  recentSegments  = [];
  allSegments     = [];
  sermonSummary   = '';
  lastEnglishTail = '';
  if (consoleWindow && !consoleWindow.closed) {
    consoleWindow.document.getElementById('log-entries').innerHTML = '';
  }
  lastEditId = 0;
  syncPopupState();
  pushSync('clear', { chunkMs: parseInt(document.getElementById('chunk-ms').value), clearedAt: Date.now() });
}

// ════════════════════════════════════════════════════════════
//  DETACHABLE CONSOLE
// ════════════════════════════════════════════════════════════
function popOutConsole() {
  if (consoleWindow && !consoleWindow.closed) {
    consoleWindow.focus();
    return;
  }

  // Hide inline drawer first
  consoleOpen = false;
  document.getElementById('console-drawer').classList.remove('open');

  var popupHTML = '<!DOCTYPE html>\n' +
    '<html lang="en"><head><meta charset="UTF-8"><title>Admin Console</title>\n' +
    '<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&display=swap" rel="stylesheet">\n' +
    '<style>\n' +
    '* { margin:0; padding:0; box-sizing:border-box; }\n' +
    'body { background:#0a0a0a; color:#fff; font-family:\'Inter\',system-ui,sans-serif; height:100vh; display:flex; flex-direction:column; overflow:hidden; }\n' +
    '#popup-header { display:flex; align-items:center; padding:12px 20px; border-bottom:1px solid #1a1a1a; flex-shrink:0; gap:10px; }\n' +
    '#popup-header > span:first-child { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:#666; }\n' +
    '#popup-controls { display:flex; align-items:center; gap:10px; padding:14px 20px; border-bottom:1px solid #1a1a1a; flex-shrink:0; flex-wrap:wrap; }\n' +
    'select { background:#111; border:1px solid #2a2a2a; border-radius:4px; padding:7px 10px; color:#fff; font-family:\'Inter\',sans-serif; font-size:12px; outline:none; cursor:pointer; }\n' +
    '.btn { padding:7px 18px; border-radius:4px; border:1px solid #2a2a2a; font-family:\'Inter\',sans-serif; font-size:12px; cursor:pointer; transition:all 0.15s; white-space:nowrap; background:transparent; color:#fff; }\n' +
    '.btn-start { background:#fff; color:#000; border-color:#fff; } .btn-start:hover { background:#ddd; }\n' +
    '.btn-stop { color:#e55; border-color:#e55; } .btn-stop:hover { background:rgba(220,50,50,0.08); }\n' +
    '.btn-muted { color:#555; } .btn-muted:hover { color:#aaa; border-color:#666; }\n' +
    '#log-panel { flex:1; overflow-y:auto; padding:10px 20px; }\n' +
    '#log-panel::-webkit-scrollbar { width:2px; } #log-panel::-webkit-scrollbar-thumb { background:#222; }\n' +
    '.log { font-family:monospace; font-size:11px; line-height:1.8; color:#3a3; }\n' +
    '.log.err { color:#e55; } .log.warn { color:#b83; } .log.info { color:#48f; }\n' +
    '#queue-depth { font-size:10px; letter-spacing:1px; text-transform:uppercase; margin-left:auto; }\n' +
    '</style></head><body>\n' +
    '<div id="popup-header">\n' +
    '  <span>Admin Console</span>\n' +
    '  <span id="queue-depth"></span>\n' +
    '  <button class="btn btn-muted" style="padding:4px 10px;font-size:11px;margin-left:auto" onclick="reattach()">&#8601; Reattach</button>\n' +
    '</div>\n' +
    '<div id="popup-controls">\n' +
    '  <button class="btn btn-start" id="btn-start" onclick="window.opener.startSession()">&#9654; Begin</button>\n' +
    '  <button class="btn btn-stop"  id="btn-stop"  onclick="window.opener.stopSession()" style="display:none">&#9632; Stop</button>\n' +
    '  <button class="btn btn-muted" onclick="window.opener.clearAll()">Clear</button>\n' +
    '  <button class="btn btn-muted" onclick="window.opener.downloadTranscript(\'Manual download\')">&#8595; Download</button>\n' +
    '  <select id="chunk-ms" onchange="window.opener.document.getElementById(\'chunk-ms\').value = this.value">\n' +
    '    <option value="20000">20s</option><option value="25000">25s</option><option value="30000">30s</option>\n' +
    '  </select>\n' +
    '</div>\n' +
    '<div id="log-panel"><div id="log-entries"></div></div>\n' +
    '<script>\n' +
    'function reattach() {\n' +
    '  if (window.opener && !window.opener.closed) window.opener._reattachConsole();\n' +
    '  window.close();\n' +
    '}\n' +
    'function addLog(text, cls) {\n' +
    '  var wrap = document.getElementById("log-entries");\n' +
    '  var el = document.createElement("div");\n' +
    '  el.className = "log " + (cls || "");\n' +
    '  el.textContent = text;\n' +
    '  wrap.appendChild(el);\n' +
    '  while (wrap.children.length > 150) wrap.removeChild(wrap.firstChild);\n' +
    '  document.getElementById("log-panel").scrollTop = 99999;\n' +
    '}\n' +
    'function setQueue(n) {\n' +
    '  var el = document.getElementById("queue-depth");\n' +
    '  if (!el) return;\n' +
    '  el.textContent = n ? "Queue: " + n + " pending" : "";\n' +
    '  el.style.color = n > 2 ? "#e55" : "#b83";\n' +
    '}\n' +
    'function syncState(listening, chunkMs) {\n' +
    '  document.getElementById("btn-start").style.display = listening ? "none" : "inline-block";\n' +
    '  document.getElementById("btn-stop").style.display  = listening ? "inline-block" : "none";\n' +
    '  var sel = document.getElementById("chunk-ms");\n' +
    '  if (sel) sel.value = chunkMs;\n' +
    '}\n' +
    'window.addEventListener("beforeunload", function() {\n' +
    '  if (window.opener && !window.opener.closed) window.opener._reattachConsole();\n' +
    '});\n' +
    '<\/script></body></html>';

  consoleWindow = window.open('', 'AdminConsole', 'width=720,height=520,resizable=yes');
  if (!consoleWindow) {
    log('Popup blocked — allow popups for this site.', 'err');
    return;
  }
  consoleWindow.document.write(popupHTML);
  consoleWindow.document.close();

  // Replay log history
  logHistory.forEach(function(entry) {
    consoleWindow.addLog(entry.text, entry.cls);
  });

  syncPopupState();
}

function _reattachConsole() {
  consoleWindow = null;
}

function syncPopupState() {
  if (!consoleWindow || consoleWindow.closed) return;
  var chunkMs = document.getElementById('chunk-ms').value;
  consoleWindow.syncState(isListening, chunkMs);
  consoleWindow.setQueue(queue.length);
}

// ════════════════════════════════════════════════════════════
//  PIPELINE
// ════════════════════════════════════════════════════════════
async function processNext() {
  updateQueueDepth();
  if (busy || !queue.length) return;
  busy = true;
  var blob = queue.shift();
  updateQueueDepth();

  try {
    log('Groq transcribing...');
    var korean = await groqTranscribe(blob);

    if (!korean || korean.trim().length < 3) {
      log('No speech detected.', 'warn');
    } else {
      log('KO: ' + korean.substring(0, 80) + (korean.length > 80 ? '...' : ''), 'info');
      log('Claude translating...');
      var result = await claudeTranslate(korean);

      if (result.music) {
        log('Music detected: ' + result.music, 'info');
        renderMusic(result.music);
      } else {
        log('EN: ' + result.english.substring(0, 80) + (result.english.length > 80 ? '...' : ''), 'info');

        var seg = { korean: korean, english: result.english };
        recentSegments.push(seg);
        if (recentSegments.length > WINDOW_SIZE) recentSegments.shift();
        allSegments.push(seg);

        var sentences = result.english.match(/[^.!?]+[.!?]+/g) || [result.english];
        lastEnglishTail = sentences.slice(-3).join(' ').trim();

        renderEntry(result);

        if (allSegments.length % SUMMARY_EVERY === 0 && !summarizing) {
          generateSermonSummary();
        }
      }
    }
  } catch (e) {
    log('Error: ' + e.message, 'err');
    toast(e.message);
  }

  busy = false;
  updateQueueDepth();
  processNext();
}

// ════════════════════════════════════════════════════════════
//  GROQ
// ════════════════════════════════════════════════════════════
async function groqTranscribe(blob) {
  var mimeMap = {
    'audio/webm': 'webm', 'audio/ogg': 'ogg',
    'audio/mp4': 'mp4', 'audio/mpeg': 'mp3', 'audio/wav': 'wav'
  };
  var baseMime = (blob.type || 'audio/webm').split(';')[0];
  var ext      = mimeMap[baseMime] || 'webm';

  var audioBase64 = await new Promise(function(res, rej) {
    var reader = new FileReader();
    reader.onload  = function() { res(reader.result.split(',')[1]); };
    reader.onerror = function() { rej(new Error('Failed to read audio')); };
    reader.readAsDataURL(blob);
  });

  // Seed Whisper with last known Korean text for domain vocabulary priming.
  // Falls back to core theological terms on the very first segment.
  var whisperPrompt = recentSegments.length
    ? recentSegments[recentSegments.length - 1].korean.replace(/[\r\n]+/g, ' ').trim().slice(0, 400)
    : '하나님 예수님 성령 은혜 구원 말씀 믿음 기도 아멘 교회 성경';

  var lastErr;
  for (var attempt = 1; attempt <= 3; attempt++) {
    try {
      var controller = new AbortController();
      var timer = setTimeout(function() { controller.abort(); }, 40000);
      var resp;
      try {
        resp = await fetch('/api/groq', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ audioBase64: audioBase64, mimeType: baseMime, ext: ext, prompt: whisperPrompt }),
          signal: controller.signal
        });
      } finally {
        clearTimeout(timer);
      }
      if (!resp.ok) {
        var msg = 'Groq HTTP ' + resp.status;
        try { var j = await resp.json(); msg = j.error || msg; } catch (_) {}
        throw new Error('Groq: ' + msg);
      }
      return (await resp.text()).trim();
    } catch (e) {
      lastErr = e;
      if (attempt < 3) {
        log('Groq retry ' + attempt + '...', 'warn');
        await new Promise(function(r) { setTimeout(r, 1000 * attempt); });
      }
    }
  }
  throw lastErr;
}

// ════════════════════════════════════════════════════════════
//  CLAUDE
// ════════════════════════════════════════════════════════════
function buildPrompt(korean) {
  var p = '';
  if (sermonSummary) p += 'SERMON SUMMARY:\n' + sermonSummary + '\n\n';
  if (recentSegments.length) {
    p += 'RECENT TRANSCRIPT:\n';
    recentSegments.forEach(function(s, i) { p += '[' + (i+1) + '] ' + s.english + '\n'; });
    p += '\n';
  }
  if (lastEnglishTail) {
    p += 'PREVIOUS SEGMENT ENDED WITH:\n"' + lastEnglishTail + '"\nIf this new Korean segment completes that thought, begin your translation with the continuation (e.g. the rest of the clause or sentence) — do NOT repeat or re-introduce what was already said. If it ends mid-clause without punctuation, your translation should flow on from it naturally.\n\n';
  }
  p += 'NEW SEGMENT:\n' + korean;
  return p;
}

async function claudeTranslate(korean) {
  var system = 'You are a Korean-to-English translation assistant for a live Christian church service displayed on screen.\n\n' +
    'The microphone may pick up not just the pastor speaking, but also musical instruments (piano, guitar, organ, drums, etc.), congregational singing, or ambient sounds.\n\n' +
    'RULES:\n' +
    '1. If the audio contains ONLY music, instruments, or singing with no clear spoken sermon content, respond with: {"music":"Piano playing"} or {"music":"Congregation singing"} or {"music":"Worship music"} etc. Be concise and descriptive.\n' +
    '2. If the audio contains spoken Korean sermon content (even alongside music), translate it normally.\n' +
    '3. Translate naturally and fluently. No wooden or literal phrasing.\n' +
    '4. Use context to maintain consistent terminology and complete sentences cut off mid-thought.\n' +
    '5. Remove all filler words (um, uh, and Korean equivalents: \uc74c, \uc5b4, \uadf8, \uc774\uc81c, \uadf8\ub83c\uc11c, etc.) and stutters.\n' +
    '6. Preserve theological terms: \ud558\ub098\ub2d8\u2192God | \uc608\uc218\ub2d8\u2192Jesus Christ | \uc131\ub839\u2192the Holy Spirit | \uc8fc\ub2d8\u2192the Lord | \ub9d0\uc3f4\u2192the Word | \uc740\ud61c\u2192grace | \uad6c\uc6d0\u2192salvation | \uc2ed\uc790\uac00\u2192the cross | \ubd80\ud65c\u2192the resurrection | \ubbf8\ub364\u2192faith | \uae30\ub3c4\u2192prayer\n' +
    '7. Convert Korean Bible references: \uc694\ud55c\ubcf5\uc74c 3\uc7a5 16\uc808\u2192John 3:16 | \uc2dc\ud3b8 23\ud3b8\u2192Psalm 23\n' +
    '8. Never begin the translation with a closing quotation mark or apostrophe. Audio is split into chunks mid-speech — if the previous chunk ended mid-quote, continue naturally without any opening quote marker.\n\n' +
    'Respond ONLY in valid JSON, no markdown:\n' +
    'For speech: {"english":"translated text","scripture":[{"ref":"John 3:16","note":""}]}\n' +
    'For music only: {"music":"description of what is playing"}';

  var lastErr;
  for (var attempt = 1; attempt <= 3; attempt++) {
    try {
      var controller = new AbortController();
      var timer = setTimeout(function() { controller.abort(); }, 30000);
      var resp;
      try {
        resp = await fetch('/api/claude', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            temperature: 0,
            system: system,
            messages: [{ role: 'user', content: buildPrompt(korean) }]
          }),
          signal: controller.signal
        });
      } finally {
        clearTimeout(timer);
      }

      if (!resp.ok) {
        var msg = 'Claude HTTP ' + resp.status;
        try { var j = await resp.json(); msg = j.error?.message || msg; } catch (_) {}
        throw new Error('Claude: ' + msg);
      }

      var data = await resp.json();
      var raw  = data.content.map(function(b) { return b.text || ''; }).join('').trim();
      try {
        return JSON.parse(raw.replace(/^```json\n?|^```\n?|\n?```$/gm, '').trim());
      } catch (_) {
        return { english: raw, scripture: [] };
      }
    } catch (e) {
      lastErr = e;
      if (attempt < 3) {
        log('Retry ' + attempt + '...', 'warn');
        await new Promise(function(r) { setTimeout(r, 1500 * attempt); });
      }
    }
  }
  throw lastErr;
}

// ════════════════════════════════════════════════════════════
//  BACKGROUND SUMMARY
// ════════════════════════════════════════════════════════════
async function generateSermonSummary() {
  summarizing = true;
  log('Updating sermon summary...', 'info');
  var transcript = allSegments.map(function(s, i) { return '[' + (i+1) + '] ' + s.english; }).join('\n');
  try {
    var controller = new AbortController();
    var timer = setTimeout(function() { controller.abort(); }, 20000);
    var resp;
    try {
      resp = await fetch('/api/claude', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 200,
          temperature: 0,
          messages: [{
            role: 'user',
            content: 'Summarize this Christian sermon in 3 sentences for a translation assistant. Cover: main theme, key points, central scriptures, direction. Plain prose only.\n\n' + transcript
          }]
        }),
        signal: controller.signal
      });
    } finally {
      clearTimeout(timer);
    }
    if (resp.ok) {
      var data = await resp.json();
      sermonSummary = data.content.map(function(b) { return b.text || ''; }).join('').trim();
      log('Summary updated.', 'info');
    }
  } catch (e) {
    log('Summary failed: ' + e.message, 'warn');
  }
  summarizing = false;
}


// ════════════════════════════════════════════════════════════
//  DOWNLOAD TRANSCRIPT
// ════════════════════════════════════════════════════════════
function downloadTranscript(reason) {
  var transcriptEl = document.getElementById('transcript');
  var entries = transcriptEl.querySelectorAll('.entry, .music-label');
  if (!entries.length) return;

  var date = new Date().toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
  var time = new Date().toLocaleTimeString('en-US', {
    hour: '2-digit', minute: '2-digit'
  });

  var lines = [];
  lines.push('SERMON TRANSCRIPT');
  lines.push(date + ' at ' + time);
  if (reason) lines.push('(' + reason + ')');
  lines.push('');
  lines.push('─'.repeat(60));
  lines.push('');

  var segCount = 0;
  entries.forEach(function(el) {
    if (el.classList.contains('music-label')) {
      lines.push('\u266a ' + el.textContent.trim());
      lines.push('');
    } else {
      var spans = el.querySelectorAll('.sentence');
      if (spans.length) {
        var text = Array.from(spans).map(function(s) { return s.textContent.trim(); }).join(' ');
        lines.push(text);
        lines.push('');
        segCount++;
      }
    }
  });

  lines.push('─'.repeat(60));
  lines.push(segCount + ' segments transcribed.');

  var blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  var filename = 'sermon-' + new Date().toISOString().slice(0,10) + '.txt';
  a.href     = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  log('Transcript downloaded: ' + filename, 'info');
}

// ════════════════════════════════════════════════════════════
//  RENDER
// ════════════════════════════════════════════════════════════
function renderMusic(description) {
  var wrap  = document.getElementById('transcript');
  var label = document.createElement('div');
  label.className   = 'music-label';
  label.textContent = description;
  wrap.appendChild(label);
  scrollToBottom();
  pushSync('entry', { id: Date.now(), type: 'music', description: description });
}

function renderEntry(result) {
  var entryId = Date.now();
  var wrap  = document.getElementById('transcript');
  var entry = document.createElement('div');
  entry.className = 'entry';
  entry.dataset.entryId = String(entryId);

  // Split english into individual sentences for easier reading
  // Strip leading quote/apostrophe artifacts from chunk-boundary continuation
  var englishText = (result.english || '').replace(/^[\s\u0027\u0022\u2018\u2019\u201C\u201D]+/, '');
  var rawSentences = englishText.match(/[^.!?]+[.!?]*/g) || [englishText];
  // Filter out empty strings
  var sentences = rawSentences.filter(function(s) { return s.trim().length > 0; });

  var sentencesHTML = sentences.map(function(s) {
    var escaped = esc(s.trim());
    // Highlight any scripture refs inline
    if (result.scripture && result.scripture.length) {
      result.scripture.forEach(function(sc) {
        if (!sc.ref) return;
        var safe = sc.ref.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        escaped = escaped.replace(new RegExp(safe, 'g'),
          '<span style="color:#666;border-bottom:1px solid #2a2a2a">' + sc.ref + '</span>');
      });
    }
    return '<span class="sentence" contenteditable="true">' + escaped + '</span>';
  }).join('');

  var scriptureBlocks = (result.scripture || [])
    .filter(function(s) { return s.ref; })
    .map(function(s) {
      return '<span class="scripture-callout">&#128214; ' + esc(s.ref) + (s.note ? ' \u2014 ' + esc(s.note) : '') + '</span>';
    }).join('');

  entry.innerHTML = sentencesHTML + scriptureBlocks;

  wrap.appendChild(entry);
  addEditListeners(entry, entryId);
  scrollToBottom();
  pushSync('entry', {
    id:        entryId,
    type:      'entry',
    sentences: sentences.map(function(s) { return s.trim(); }),
    scripture: result.scripture || []
  });
}

function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}


// ════════════════════════════════════════════════════════════
//  TYPOGRAPHY CONTROLS
// ════════════════════════════════════════════════════════════
function applyTypography() {
  var fontSize   = parseInt(document.getElementById('font-size-slider').value);
  var lineHeight = parseInt(document.getElementById('line-height-slider').value);

  document.getElementById('font-size-val').textContent   = fontSize + 'px';
  document.getElementById('line-height-val').textContent = lineHeight + 'px';

  // Apply to all existing and future sentences via CSS vars
  document.documentElement.style.setProperty('--sentence-size',    fontSize + 'px');
  document.documentElement.style.setProperty('--sentence-spacing',  lineHeight + 'px');

  // Scroll to bottom after resize so latest text stays visible
  var main = document.getElementById('main');
  main.scrollTop = main.scrollHeight;
}

// Init CSS vars on load; block Enter inside editable sentences
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('transcript').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') e.preventDefault();
  });

  if (isRemote) {
    initRemote();
  } else {
    applyTypography();
    setInterval(pollCommands, 3000);
  }
});


// Download transcript if page is closed or refreshed (laptop only)
window.addEventListener('beforeunload', function() {
  if (!isRemote) downloadTranscript('Page closed');
});

// ════════════════════════════════════════════════════════════
//  RESIZE CONSOLE DRAWER
// ════════════════════════════════════════════════════════════
(function() {
  var handle  = document.getElementById('resize-handle');
  var drawer  = document.getElementById('console-drawer');
  var startY  = 0;
  var startH  = 0;
  var dragging = false;

  handle.addEventListener('mousedown', function(e) {
    dragging = true;
    startY   = e.clientY;
    startH   = drawer.offsetHeight;
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  document.addEventListener('mousemove', function(e) {
    if (!dragging) return;
    var delta  = startY - e.clientY;  // drag up = bigger
    var newH   = Math.min(Math.max(startH + delta, 160), window.innerHeight * 0.9);
    drawer.style.height = newH + 'px';
  });

  document.addEventListener('mouseup', function() {
    dragging = false;
    document.body.style.userSelect = '';
  });

  // Touch support
  handle.addEventListener('touchstart', function(e) {
    dragging = true;
    startY   = e.touches[0].clientY;
    startH   = drawer.offsetHeight;
    e.preventDefault();
  }, { passive: false });

  document.addEventListener('touchmove', function(e) {
    if (!dragging) return;
    var delta = startY - e.touches[0].clientY;
    var newH  = Math.min(Math.max(startH + delta, 160), window.innerHeight * 0.9);
    drawer.style.height = newH + 'px';
  }, { passive: true });

  document.addEventListener('touchend', function() { dragging = false; });
})();
</script>
</body>
</html>
